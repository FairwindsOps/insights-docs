(window.webpackJsonp=window.webpackJsonp||[]).push([[16],{362:function(t,a,s){"use strict";s.r(a);var e=s(42),n=Object(e.a)({},(function(){var t=this,a=t.$createElement,s=t._self._c||a;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"admission-controller"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#admission-controller"}},[t._v("#")]),t._v(" Admission Controller")]),t._v(" "),s("blockquote",[s("p",[s("strong",[t._v("This feature is currently in beta")])])]),t._v(" "),s("p",[t._v("Fairwinds Insights can also run as an Admission Controller -\nit will reject any Kubernetes resources from entering your cluster\nif they don't conform to your organization's policies.")]),t._v(" "),s("h2",{attrs:{id:"requirements"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#requirements"}},[t._v("#")]),t._v(" Requirements")]),t._v(" "),s("p",[t._v("The default installation requires "),s("a",{attrs:{href:"https://cert-manager.io/docs/installation/kubernetes/",target:"_blank",rel:"noopener noreferrer"}},[t._v("cert-manager"),s("OutboundLink")],1),t._v("\nv1.0 or greater.")]),t._v(" "),s("p",[t._v("If you don't have cert-manager, or if you'd like to provide your own certificate for the webhook, you can use the\n"),s("code",[t._v("caBundle")]),t._v(" and "),s("code",[t._v("secretName")]),t._v(" parameters to pass a CA Bundle and the location of a TLS certificate\nstored in your cluster.")]),t._v(" "),s("h2",{attrs:{id:"installation"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#installation"}},[t._v("#")]),t._v(" Installation")]),t._v(" "),s("p",[t._v("To use the Admission Controller, install it on your cluster:")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("helm repo "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("add")]),t._v(" fairwinds-stable https://charts.fairwinds.com/stable\n\nkubectl create namespace insights-admission\n\nhelm upgrade --install insights-admission fairwinds-stable/insights-admission "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  --namespace insights-admission "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  --set insights.organization"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("acme-co "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  --set insights.cluster"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("staging "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  --set insights.base64token"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"dG9rZW4="')]),t._v("\n")])])]),s("p",[t._v("You can find the correct values for "),s("code",[t._v("organization")]),t._v(", "),s("code",[t._v("cluster")]),t._v(", and "),s("code",[t._v("base64token")]),t._v("\non your cluster's settings page, inside the "),s("code",[t._v("helm upgrade")]),t._v(" command shown there.")]),t._v(" "),s("p",[t._v("To test it out, let's try and create a deployment that would create a "),s("code",[t._v("danger")]),t._v(" Action Item\nby allowing privilige escalation:")]),t._v(" "),s("p",[s("strong",[t._v("bad-config.yaml")])]),t._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("apiVersion")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" apps/v1\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("kind")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Deployment\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("metadata")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" busybox"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("deployment\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("namespace")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" testing\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("spec")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("replicas")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("selector")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("matchLabels")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("app")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" busybox\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("template")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("metadata")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("labels")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("app")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" busybox\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("spec")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("containers")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" busybox\n        "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" busybox"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1.32")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("securityContext")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n          "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("allowPrivilegeEscalation")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean important"}},[t._v("true")]),t._v("\nEOF\n")])])]),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("kubectl create ns testing\nkubeclt apply -f bad-config.yaml\n")])])]),s("p",[t._v("You should see a message saying:")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v('Error from server (Privilege escalation should not be allowed: Failure: true): error when creating "STDIN": admission webhook "insights.fairwinds.com" denied the request: Privilege escalation should not be allowed: Failure: true\n')])])]),s("h2",{attrs:{id:"resources"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#resources"}},[t._v("#")]),t._v(" Resources")]),t._v(" "),s("p",[t._v("By default, the Admission Controller will monitor the following resources:")]),t._v(" "),s("ul",[s("li",[s("code",[t._v("apps/(v1|v1beta1|v1beta2)")]),t._v(" "),s("ul",[s("li",[t._v("Deployments")]),t._v(" "),s("li",[t._v("DaemonSets")]),t._v(" "),s("li",[t._v("StatefulSets")])])]),t._v(" "),s("li",[s("code",[t._v("batch/(v1|v1beta1)")]),t._v(" "),s("ul",[s("li",[t._v("Jobs")]),t._v(" "),s("li",[t._v("CronJobs")])])]),t._v(" "),s("li",[s("code",[t._v("core/v1")]),t._v(" "),s("ul",[s("li",[t._v("Pods")]),t._v(" "),s("li",[t._v("ReplicationControllers")])])])]),t._v(" "),s("p",[t._v("If you'd like to add additional resources, you can use the "),s("code",[t._v("rules")]),t._v("\nsetting on the Helm chart:")]),t._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("rules")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("apiGroups")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" custom\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("apiVersions")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" v1\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("operations")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" CREATE\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" UPDATE\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("resources")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" customResource\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("scope")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Namespaced\n")])])]),s("h2",{attrs:{id:"configuration"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#configuration"}},[t._v("#")]),t._v(" Configuration")]),t._v(" "),s("p",[t._v("You can fine-tune which rules are applied by the admission controller. Specifically, the following auditing tools\ncan be enabled or disabled as part of admission control:")]),t._v(" "),s("ul",[s("li",[t._v("Polaris - checks for security and best practices")]),t._v(" "),s("li",[t._v("OPA - apply custom policies to resources ("),s("a",{attrs:{href:"/reports/opa"}},[t._v("see docs")]),t._v(")")]),t._v(" "),s("li",[t._v("Pluto - disallow resources that have been deprecated")])]),t._v(" "),s("p",[t._v("To enable or disable a particular report, run:")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("curl")]),t._v(" -X POST https://insights.fairwinds.com/v0/organizations/"),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$org")]),t._v("/admission/reports/"),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$report")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  -H "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Authorization: Bearer '),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$token")]),t._v('"')]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  -d "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'{\"enabled\": false}'")]),t._v("\n")])])]),s("p",[t._v("where:")]),t._v(" "),s("ul",[s("li",[s("code",[t._v("$report")]),t._v(" is one of "),s("code",[t._v("polaris")]),t._v(", "),s("code",[t._v("opa")]),t._v(", or "),s("code",[t._v("pluto")])]),t._v(" "),s("li",[s("code",[t._v("$org")]),t._v(" is your organization's name in Insights")]),t._v(" "),s("li",[s("code",[t._v("$token")]),t._v(" is the admin token found on your organization settings page")])]),t._v(" "),s("h3",{attrs:{id:"polaris"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#polaris"}},[t._v("#")]),t._v(" Polaris")]),t._v(" "),s("p",[t._v("You can also upload a custom\n"),s("a",{attrs:{href:"https://github.com/FairwindsOps/polaris/blob/master/docs/usage.md#configuration",target:"_blank",rel:"noopener noreferrer"}},[t._v("Polaris configuration"),s("OutboundLink")],1),t._v("\nto set which checks are marked as "),s("code",[t._v("danger")]),t._v(", and will therefore cause a workload to be rejected.")]),t._v(" "),s("p",[t._v("You can also use the Polaris configuration to write\n"),s("a",{attrs:{href:"https://github.com/FairwindsOps/polaris/blob/master/docs/usage.md#custom-checks",target:"_blank",rel:"noopener noreferrer"}},[t._v("custom checks using JSON Schema"),s("OutboundLink")],1)]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v('curl -X POST https://insights.fairwinds.com/v0/organizations/$org/admission/reports/polaris/config \\\n  -H "Authorization: Bearer $token" \\\n  -H "Content-Type: text/yaml" \\\n  -d @polaris-config.yaml\n')])])]),s("h3",{attrs:{id:"opa"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#opa"}},[t._v("#")]),t._v(" OPA")]),t._v(" "),s("p",[t._v("To create custom OPA policies for your organization, see the\n"),s("a",{attrs:{href:"/reports/opa"}},[t._v("OPA docs")]),t._v(". To reject a resource, you'll need to ensure that\nyour OPA policy generates an Action Item with "),s("code",[t._v("severity >= 0.67")]),t._v(".")])])}),[],!1,null,null,null);a.default=n.exports}}]);