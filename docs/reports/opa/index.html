<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>OPA | Fairwinds Insights Documentation</title>
    <meta name="generator" content="VuePress 1.5.3">
    <link rel="icon" href="/favicon.png">
    <meta name="description" content="Documentation for the Fairwinds Insights Kubernetes auditing platform">
    <link rel="preload" href="/assets/css/0.styles.ba7d046e.css" as="style"><link rel="preload" href="/assets/js/app.366209af.js" as="script"><link rel="preload" href="/assets/js/2.d0aaf875.js" as="script"><link rel="preload" href="/assets/js/38.4d7f3b96.js" as="script"><link rel="prefetch" href="/assets/js/10.95e8994a.js"><link rel="prefetch" href="/assets/js/11.94fbe278.js"><link rel="prefetch" href="/assets/js/12.b8f74e49.js"><link rel="prefetch" href="/assets/js/13.417d7acf.js"><link rel="prefetch" href="/assets/js/14.d4ef333c.js"><link rel="prefetch" href="/assets/js/15.a1e203fe.js"><link rel="prefetch" href="/assets/js/16.750dd917.js"><link rel="prefetch" href="/assets/js/17.621910ba.js"><link rel="prefetch" href="/assets/js/18.eba82b88.js"><link rel="prefetch" href="/assets/js/19.2a14d92a.js"><link rel="prefetch" href="/assets/js/20.3d90e869.js"><link rel="prefetch" href="/assets/js/21.ff9d7b11.js"><link rel="prefetch" href="/assets/js/22.25e91b18.js"><link rel="prefetch" href="/assets/js/23.40dedfe7.js"><link rel="prefetch" href="/assets/js/24.a1eec3e6.js"><link rel="prefetch" href="/assets/js/25.9137701c.js"><link rel="prefetch" href="/assets/js/26.b36c827d.js"><link rel="prefetch" href="/assets/js/27.b3805ed0.js"><link rel="prefetch" href="/assets/js/28.c3dcddeb.js"><link rel="prefetch" href="/assets/js/29.595ff651.js"><link rel="prefetch" href="/assets/js/3.ce101635.js"><link rel="prefetch" href="/assets/js/30.856ccb8d.js"><link rel="prefetch" href="/assets/js/31.e17b8726.js"><link rel="prefetch" href="/assets/js/32.bccde10e.js"><link rel="prefetch" href="/assets/js/33.a2dabcad.js"><link rel="prefetch" href="/assets/js/34.b2ab66d6.js"><link rel="prefetch" href="/assets/js/35.abb4d0db.js"><link rel="prefetch" href="/assets/js/36.d08c1f2a.js"><link rel="prefetch" href="/assets/js/37.70e613ea.js"><link rel="prefetch" href="/assets/js/39.ce64c15b.js"><link rel="prefetch" href="/assets/js/4.3b6a7e49.js"><link rel="prefetch" href="/assets/js/40.9b166f6b.js"><link rel="prefetch" href="/assets/js/41.12f20647.js"><link rel="prefetch" href="/assets/js/42.39a0b141.js"><link rel="prefetch" href="/assets/js/43.675c0cad.js"><link rel="prefetch" href="/assets/js/5.c03b1cde.js"><link rel="prefetch" href="/assets/js/6.7c1f35f3.js"><link rel="prefetch" href="/assets/js/7.28757c16.js"><link rel="prefetch" href="/assets/js/8.72bdfd08.js"><link rel="prefetch" href="/assets/js/9.9665c39f.js">
    <link rel="stylesheet" href="/assets/css/0.styles.ba7d046e.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.svg" alt="Fairwinds Insights Documentation" class="logo"> <span class="site-name can-hide">Fairwinds Insights Documentation</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><a href="/" aria-current="page" class="sidebar-link">Home</a></li><li><a href="/release-notes/" class="sidebar-link">Release Notes</a></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Installation</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/installation/getting-started/" class="sidebar-link">Getting Started</a></li><li><a href="/installation/insights-agent/" class="sidebar-link">Insights Agent</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>First Steps</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Features</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Reports</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/reports/polaris/" class="sidebar-link">Polaris</a></li><li><a href="/reports/goldilocks/" class="sidebar-link">Goldilocks</a></li><li><a href="/reports/trivy/" class="sidebar-link">Trivy</a></li><li><a href="/reports/opa/" aria-current="page" class="active sidebar-link">OPA</a></li><li><a href="/reports/kubesec/" class="sidebar-link">Kubesec</a></li><li><a href="/reports/kube-hunter/" class="sidebar-link">Kube-hunter</a></li><li><a href="/reports/nova/" class="sidebar-link">Nova</a></li><li><a href="/reports/rbac-reporter/" class="sidebar-link">RBAC Reporter</a></li><li><a href="/reports/workloads/" class="sidebar-link">Workloads</a></li><li><a href="/reports/rbac-requirements/" class="sidebar-link">RBAC Requirements</a></li><li><a href="/reports/new/" class="sidebar-link">Create a new report</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Integrations</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Management</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>API Access</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Architecture</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="opa"><a href="#opa" class="header-anchor">#</a> OPA</h1> <p>Fairwinds Insights supports the use of custom OPA policies to create Action Items.</p> <h2 id="enable-the-opa-agent"><a href="#enable-the-opa-agent" class="header-anchor">#</a> Enable the OPA agent</h2> <p>To enable OPA, make sure you pass <code>--set opa.enabled=true</code> when
<a href="/installation/insights-agent">installing the insights-agent</a></p> <h2 id="designing-policies"><a href="#designing-policies" class="header-anchor">#</a> Designing Policies</h2> <blockquote><p>You may want to familiarize yourself with
<a href="https://www.openpolicyagent.org/docs/latest/policy-language/" target="_blank" rel="noopener noreferrer">Rego<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>,
the policy language used by OPA.</p></blockquote> <p>Each Rego policy will recieve an <code>input</code> parameter, which contains
a Kubernetes resource.</p> <p>For example, we can check to make sure that <code>replicas</code> is set on all <code>Deployments</code></p> <div class="language-rego extra-class"><pre class="language-text"><code>package fairwinds

replicasRequired[actionItem] {
  input.spec.replicas == 0
  actionItem := {}
}
</code></pre></div><p>The <code>actionItem</code> object is what Insights will examine to determine the details of the
issue. The following fields can be set:</p> <ul><li><code>title</code> - a short title for the Action Item</li> <li><code>description</code> - a longer description of the issue. Can include markdown.</li> <li><code>remediation</code> - instructions for fixing the issue. Can include markdown.</li> <li><code>category</code> - can be Security, Efficiency, or Reliability</li> <li><code>severity</code> - between 0.0 and 1.0. &gt; .66 will become a <code>danger</code> item</li></ul> <p>For instance, on our check above, we could set:</p> <div class="language-rego extra-class"><pre class="language-text"><code>package fairwinds

replicasRequired[actionItem] {
  input.spec.replicas == 0
  actionItem := {
    &quot;title&quot;: concat(&quot; &quot;, [input.kind, &quot;does not have replicas set&quot;]),
    &quot;description&quot;: &quot;All workloads at acme-co must explicitly set the number of replicas. [Read more](https://kubernetes.io/docs/concepts/workloads/controllers/deployment/#creating-a-deployment)&quot;,
    &quot;remediation&quot;: &quot;Please set `spec.replicas`&quot;,
    &quot;category&quot;: &quot;Reliability&quot;,
    &quot;severity&quot;: 0.5
  }
}
</code></pre></div><h2 id="uploading-policies"><a href="#uploading-policies" class="header-anchor">#</a> Uploading Policies</h2> <p>To add your policies to Insights, you'll need to use the API. You can find your API key on your organization's
settings page (note: you must be an admin for your organization).</p> <p>Lets upload our <code>replicasRequired</code> check by creating <code>replicas.rego</code>:</p> <div class="language-rego extra-class"><pre class="language-text"><code>package fairwinds

replicasRequired[actionItem] {
  input.spec.replicas == 0
  actionItem := {
    &quot;title&quot;: concat(&quot; &quot;, [input.kind, &quot;does not have replicas set&quot;]),
    &quot;description&quot;: &quot;All workloads at acme-co must explicitly set the number of replicas. [Read more](https://kubernetes.io/docs/concepts/workloads/controllers/deployment/#creating-a-deployment)&quot;,
    &quot;remediation&quot;: &quot;Please set `spec.replicas`&quot;,
    &quot;category&quot;: &quot;Reliability&quot;,
    &quot;severity&quot;: 0.5
  }
}
</code></pre></div><p>Then, use the Insights API to add your check:</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token builtin class-name">export</span> <span class="token assign-left variable">checkName</span><span class="token operator">=</span>replicas
<span class="token builtin class-name">export</span> <span class="token assign-left variable">organization</span><span class="token operator">=</span>acme-co <span class="token comment"># your org name in Insights</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">token</span><span class="token operator">=</span>abcde <span class="token comment"># get this from your org settings page</span>
<span class="token function">curl</span> -X PUT -H <span class="token string">&quot;Content-type: text/plain&quot;</span> <span class="token punctuation">\</span>
  -H <span class="token string">&quot;Authorization: Bearer <span class="token variable">$token</span>&quot;</span> <span class="token punctuation">\</span>
  <span class="token string">&quot;https://insights.fairwinds.com/v0/organizations/<span class="token variable">$organization</span>/opa/customChecks/<span class="token variable">$checkName</span>&quot;</span> <span class="token punctuation">\</span>
  --data-binary @replicas.rego
</code></pre></div><p>Next, we need to create a <code>checkInstance</code> to tell Insights what sorts of resources to apply our check to:</p> <p><strong>deployments.yaml</strong></p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">targets</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;apps&quot;</span><span class="token punctuation">]</span>
  <span class="token key atrule">kinds</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;Deployment&quot;</span><span class="token punctuation">]</span>
</code></pre></div><div class="language-bash extra-class"><pre class="language-bash"><code><span class="token builtin class-name">export</span> <span class="token assign-left variable">instanceName</span><span class="token operator">=</span>deployments
<span class="token function">curl</span> -X PUT -H <span class="token string">&quot;Content-type: application/x-yaml&quot;</span> <span class="token punctuation">\</span>
  -H <span class="token string">&quot;Authorization: Bearer <span class="token variable">$token</span>&quot;</span> <span class="token punctuation">\</span>
  <span class="token string">&quot;https://insights.fairwinds.com/v0/organizations/<span class="token variable">$organization</span>/opa/customChecks/<span class="token variable">$checkName</span>/instances/<span class="token variable">$instanceName</span>&quot;</span> <span class="token punctuation">\</span>
  --data-binary @deployments.yaml
</code></pre></div><h2 id="testing-your-policies"><a href="#testing-your-policies" class="header-anchor">#</a> Testing your Policies</h2> <p>After uploading new checks, it's good to test that they're working properly. To do so, you can
manually create a one-off report:</p> <div class="language- extra-class"><pre class="language-text"><code>kubectl create job my-opa-test --from=cronjob/opa -n insights-agent
</code></pre></div><p>Watch the logs for the resulting Job to spot any potential errors in your work.</p> <h2 id="reusing-rego-policies"><a href="#reusing-rego-policies" class="header-anchor">#</a> Reusing Rego Policies</h2> <p>You can reuse the same Rego policy, setting different ActionItem attributes in different cases.
For instance, say we wanted to apply our <code>replicas</code> policy above to both <code>Deployments</code> and <code>StatefulSets</code>,
but wanted a higher severity for <code>Deployments</code>.</p> <p>First, we'd stop specifying <code>severity</code> inside our OPA, so that it can be set by the instance:
<strong>replicas.rego</strong></p> <div class="language-rego extra-class"><pre class="language-text"><code>package fairwinds

replicasRequired[actionItem] {
  input.spec.replicas == 0
  actionItem := {
    &quot;title&quot;: concat(&quot; &quot;, [input.kind, &quot;does not have replicas set&quot;]),
    &quot;description&quot;: &quot;All workloads at acme-co must explicitly set the number of replicas. [Read more](https://kubernetes.io/docs/concepts/workloads/controllers/deployment/#creating-a-deployment)&quot;,
    &quot;remediation&quot;: &quot;Please set `spec.replicas`&quot;,
    &quot;category&quot;: &quot;Reliability&quot;,
  }
}
</code></pre></div><p>Next, we'd create two instances:
<strong>deployments.yaml</strong></p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">output</span><span class="token punctuation">:</span>
  <span class="token key atrule">severity</span><span class="token punctuation">:</span> <span class="token number">.9</span>
<span class="token key atrule">targets</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;apps&quot;</span><span class="token punctuation">]</span>
  <span class="token key atrule">kinds</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;Deployment&quot;</span><span class="token punctuation">]</span>
</code></pre></div><p><strong>statefulSets.yaml</strong></p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">output</span><span class="token punctuation">:</span>
  <span class="token key atrule">severity</span><span class="token punctuation">:</span> <span class="token number">.4</span>
<span class="token key atrule">targets</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;apps&quot;</span><span class="token punctuation">]</span>
  <span class="token key atrule">kinds</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;StatefulSet&quot;</span><span class="token punctuation">]</span>
</code></pre></div><h3 id="parameters"><a href="#parameters" class="header-anchor">#</a> Parameters</h3> <p>We can also pass parameters to our instances. Say, for instance, that we wanted all Deployments to have at least 3 replicas,
but StatefulSets were OK with a single replica. Then we could write:</p> <div class="language-rego extra-class"><pre class="language-text"><code>package fairwinds

replicasRequired[actionItem] {
  input.spec.replicas &lt; input.parameters.minReplicas
  actionItem := {
    &quot;title&quot;: concat(&quot; &quot;, [input.kind, &quot;does not have enough replicas set&quot;]),
    &quot;description&quot;: &quot;All workloads at acme-co must explicitly set the number of replicas. [Read more](https://kubernetes.io/docs/concepts/workloads/controllers/deployment/#creating-a-deployment)&quot;,
    &quot;remediation&quot;: &quot;Please set `spec.replicas`&quot;,
    &quot;category&quot;: &quot;Reliability&quot;,
  }
}
</code></pre></div><p><strong>deployments.yaml</strong></p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">parameters</span><span class="token punctuation">:</span>
  <span class="token key atrule">minReplicas</span><span class="token punctuation">:</span> <span class="token number">3</span>
<span class="token key atrule">targets</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;apps&quot;</span><span class="token punctuation">]</span>
  <span class="token key atrule">kinds</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;Deployment&quot;</span><span class="token punctuation">]</span>
</code></pre></div><p><strong>statefulSets.yaml</strong></p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">parameters</span><span class="token punctuation">:</span>
  <span class="token key atrule">minReplicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
<span class="token key atrule">targets</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;apps&quot;</span><span class="token punctuation">]</span>
  <span class="token key atrule">kinds</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;StatefulSet&quot;</span><span class="token punctuation">]</span>
</code></pre></div><h2 id="using-the-kubernetes-api"><a href="#using-the-kubernetes-api" class="header-anchor">#</a> Using the Kubernetes API</h2> <p>You can also cross-check resources with other Kubernetes objects. For example, we could use
this check to ensure that all <code>Deployments</code> have an associated <code>HorizontalPodAutoscaler</code>:</p> <div class="language-rego extra-class"><pre class="language-text"><code>package fairwinds

hasMatchingHPA(hpas, elem) {
  hpa := hpas[_]
  hpa.spec.scaleTargetRef.kind == elem.kind
  hpa.spec.scaleTargetRef.name == elem.metadata.name
  hpa.metadata.namespace == elem.metadata.namespace
  hpa.spec.scaleTargetRef.apiVersion == elem.apiVersion
}
hpaRequired[actionItem] {
  not hasMatchingHPA(kubernetes(&quot;autoscaling&quot;, &quot;HorizontalPodAutoscaler&quot;), input)
  actionItem := {
    &quot;title&quot;: &quot;No horizontal pod autoscaler found&quot;
  }
}
</code></pre></div><h2 id="more-examples"><a href="#more-examples" class="header-anchor">#</a> More Examples</h2> <p>You can find more examples in the <a href="https://github.com/FairwindsOps/insights-plugins/tree/master/plugins/opa/examples" target="_blank" rel="noopener noreferrer">Insights Plugins repository<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/FairwindsOps/insights-docs/edit/master/reports/opa.md" target="_blank" rel="noopener noreferrer">Help us improve this page</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/reports/trivy/" class="prev">
        Trivy
      </a></span> <span class="next"><a href="/reports/kubesec/">
        Kubesec
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.366209af.js" defer></script><script src="/assets/js/2.d0aaf875.js" defer></script><script src="/assets/js/38.4d7f3b96.js" defer></script>
  </body>
</html>
